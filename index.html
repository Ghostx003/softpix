<!DOCTYPE html>
<html lang="en" data-theme="dark" data-accent="green">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Softpix</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for Theming */
        :root { /* Light theme */
            --bg-primary: #f9fafb; --bg-secondary: #ffffff; --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937; --text-secondary: #6b7280; --text-on-accent: #ffffff;
            --border-primary: #e5e7eb; --border-secondary: #d1d5db;
        }
        
        html[data-theme="dark"] { /* Dark theme */
            --bg-primary: #000000; --bg-secondary: #121212; --bg-tertiary: #1E1E1E;
            --text-primary: #f5f5f5; --text-secondary: #a3a3a3;
            --border-primary: #27272a; --border-secondary: #3f3f46;
        }

        /* Accent Color Variables */
        html[data-accent="green"] { --accent-primary: #16a34a; --accent-hover: #15803d; --accent-primary_translucent: rgba(34, 197, 94, 0.4); }
        html[data-accent="blue"] { --accent-primary: #2563eb; --accent-hover: #1d4ed8; --accent-primary_translucent: rgba(59, 130, 246, 0.4); }
        html[data-accent="red"] { --accent-primary: #dc2626; --accent-hover: #b91c1c; --accent-primary_translucent: rgba(239, 68, 68, 0.4); }
        html[data-accent="purple"] { --accent-primary: #9333ea; --accent-hover: #7e22ce; --accent-primary_translucent: rgba(168, 85, 247, 0.4); }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.2s, color 0.2s;
            margin: 0;
            overflow-x: hidden;
        }
        
        /* General UI Element Styling */
        .btn-primary { 
            background-color: var(--accent-primary); color: var(--text-on-accent); padding: 0.6rem 1.2rem;
            border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary, .btn-icon {
            background-color: var(--bg-tertiary); color: var(--text-primary); padding: 0.5rem 1rem;
            border-radius: 0.5rem; border: 1px solid var(--border-primary); font-weight: 600;
            cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-secondary:hover, .btn-icon:hover { background-color: var(--border-primary); }
        .input-main { 
            background-color: var(--bg-tertiary); border: 1px solid var(--border-secondary); color: var(--text-primary);
            border-radius: 0.5rem; padding: 0.75rem; width: 100%; box-sizing: border-box;
        }
        .input-main:focus { 
            border-color: var(--accent-primary); outline: none; 
            box-shadow: 0 0 0 2px var(--accent-primary_translucent);
        }

        /* --- NEW SURPRISE BUTTON STYLE --- */
        .btn-surprise {
            background-color: #22c55e; /* Bright Green */
            color: #022c22; /* Very Dark Green Text */
            border: 2px solid #16a34a;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            margin-right: 0.5rem;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-surprise:hover {
            background-color: #16a34a;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
        }

        /* --- Nav Bar & Sidebar Styles --- */
        .navbar {
            padding: 0.75rem 1.5rem; background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary); display: flex;
            justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50;
        }
        .navbar .logo { font-size: 1.5rem; font-weight: 700; }
        .nav-controls { display: flex; align-items: center; gap: 0.75rem; }
        .sort-select {
            background-color: var(--bg-tertiary); color: var(--text-primary); font-weight: 500;
            border: 1px solid var(--border-primary); border-radius: 0.375rem; padding: 0.5rem; appearance: none;
        }
        .hamburger-menu { background: none; border: none; cursor: pointer; padding: 0.5rem; }
        .hamburger-menu svg { stroke: var(--text-primary); }
        .sidebar-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0);
            z-index: 998; transition: background-color 0.3s; pointer-events: none;
        }
        .sidebar-overlay.visible { background-color: rgba(0,0,0,0.5); pointer-events: all; }
        .sidebar {
            position: fixed; top: 0; right: 0; height: 100%; width: 280px;
            background-color: var(--bg-secondary); box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 999; transform: translateX(100%); transition: transform 0.3s ease-in-out;
            padding: 1.5rem; box-sizing: border-box; display: flex; flex-direction: column; gap: 1rem;
            overflow-y: auto;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-header h4 { margin: 0; }
        #close-sidebar-btn {
            background: none; border: none; color: var(--text-secondary); font-size: 1.5rem;
            cursor: pointer; padding: 0.25rem; line-height: 1; transition: color 0.2s;
        }
        #close-sidebar-btn:hover { color: var(--text-primary); }
        .theme-btn {
            width: 3rem; height: 3rem; border-radius: 50%; border: 3px solid transparent;
            cursor: pointer; transition: border-color 0.2s;
        }
        .theme-btn.active { border-color: var(--accent-primary); }
        #user-profile-form, #add-image-url-form { display: flex; flex-direction: column; gap: 0.75rem; }
        #user-profile-form label, #add-image-url-form label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }

        /* --- Tag Bar --- */
        .tag-bar {
            background-color: var(--bg-secondary); display: flex; align-items: center;
            gap: 0.75rem; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-primary);
            overflow-x: auto; white-space: nowrap;
        }
        .tag-bar::-webkit-scrollbar { height: 4px; }
        .tag-bar::-webkit-scrollbar-thumb { background: var(--border-secondary); border-radius: 2px; }
        .tag-btn-container { position: relative; display: inline-flex; align-items: center; }
        .tag-btn {
            background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 0.3rem 0.8rem;
            border: 1px solid var(--border-primary); border-radius: 999px; font-size: 0.8rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .tag-btn:hover, .tag-btn.active { background-color: var(--accent-primary); color: var(--text-on-accent); border-color: var(--accent-primary); }
        .delete-tag-btn {
            position: absolute; right: -5px; top: -5px; width: 18px; height: 18px; border-radius: 50%;
            background-color: #f44336; color: white; border: none; display: flex; align-items: center;
            justify-content: center; font-size: 0.8rem; line-height: 1; cursor: pointer;
            opacity: 0; transition: opacity 0.2s, transform 0.2s;
        }
        .tag-btn-container:hover .delete-tag-btn { opacity: 1; transform: scale(1.1); }
        .clear-filter-btn { font-weight: 600; color: var(--accent-primary); background: none; border: none; cursor: pointer; }


        /* --- App Specific Styles --- */
        #image-grid {
            margin: 2rem; display: grid;
            gap: 2rem;
            /* Default responsive, will be overridden by JS if specific count selected */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        .pin-container {
            position: relative; border-radius: 1rem; overflow: hidden;
            background-color: var(--bg-tertiary); cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            aspect-ratio: 4 / 3; /* Uniform dimensions */
        }
        html[data-theme="dark"] .pin-container:hover {
            box-shadow: 0 0 15px -2px var(--accent-primary_translucent); transform: translateY(-2px);
        }
        /* Support for both img and video in grid */
        .pin-container img, .pin-container video { 
            width: 100%; height: 100%; object-fit: cover; display: block;
        }
        
        .pin-btn, .delete-btn {
            position: absolute; background: rgba(0,0,0,0.5);
            border: none; border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: opacity 0.2s, background-color 0.2s; z-index: 10;
        }
        .pin-container:hover .pin-btn, .pin-container:hover .delete-btn { opacity: 1; }
        .pin-btn { top: 10px; right: 10px; }
        .delete-btn { top: 10px; left: 10px; background: rgba(239, 68, 68, 0.7);}
        .delete-btn:hover { background: rgba(220, 38, 38, 1); }
        .pin-btn svg, .delete-btn svg { stroke: white; transition: fill 0.2s, stroke 0.2s; }
        .pin-btn.active { background: var(--accent-primary); }
        .pin-btn.active svg { fill: white; }

        /* Video Indicator (Optional) */
        .video-indicator {
            position: absolute; bottom: 10px; right: 10px; 
            background: rgba(0,0,0,0.6); color: white;
            padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; pointer-events: none;
        }

        #empty-state, #resume-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; min-height: 60vh;
        }

        #resume-state { display: none; }

        /* --- Modal Styles --- */
        #image-modal, #name-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: none; align-items: center;
            justify-content: center; z-index: 100;
        }
        #name-modal { z-index: 1001; }
        .modal-content {
            background-color: var(--bg-secondary); border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; height: 90%;
            max-width: 1200px; display: flex; overflow: hidden;
        }
        .modal-image-container {
            flex: 3; background-color: var(--bg-primary); display: flex;
            align-items: center; justify-content: center; padding: 1rem; position: relative;
        }
        /* Modal media styles */
        .modal-image-container img, .modal-image-container video { 
            max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 0.5rem; 
        }
        .hidden-media { display: none !important; }

        .modal-details-container {
            flex: 1; min-width: 320px; padding: 1.5rem; display: flex;
            flex-direction: column; border-left: 1px solid var(--border-primary);
        }
        .modal-details-container h3 { margin: 0 0 1rem 0; word-wrap: break-word; }
        
        #comments-container {
            overflow-y: auto; margin-bottom: 1rem; flex-grow: 1; 
            /* Ensure comments don't push the toggle off screen */
            min-height: 0; 
        }
        
        /* RATING STYLES (NEW) */
        .rating-section {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .rating-stars {
            display: flex;
            gap: 2px;
            cursor: pointer;
        }
        .star-icon {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: var(--text-secondary);
            stroke-width: 1.5;
            transition: fill 0.2s, stroke 0.2s, transform 0.1s;
        }
        /* Active or Hovered State */
        .star-icon.filled {
            fill: #fbbf24; /* Gold/Yellow */
            stroke: #d97706;
        }
        .star-icon:hover {
            transform: scale(1.2);
        }

        .comment {
            background-color: var(--bg-tertiary); padding: 0.75rem; border-radius: 0.5rem;
            margin-bottom: 0.75rem; font-size: 0.9rem; position: relative;
        }
        .comment-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem; }
        .comment-avatar {
            width: 28px; height: 28px; border-radius: 50%; background-color: var(--accent-primary);
            color: var(--text-on-accent); display: flex; align-items: center;
            justify-content: center; font-weight: 600; font-size: 0.9rem; flex-shrink: 0;
            object-fit: cover; border: 1px solid var(--border-primary);
        }
        .comment-author { font-weight: 600; }
        .comment-date { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .delete-comment-btn {
            position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border-radius: 50%;
            background-color: #f44336; color: white; border: none; display: flex; align-items: center;
            justify-content: center; font-size: 0.8rem; line-height: 1; cursor: pointer;
            opacity: 0; transition: opacity 0.2s, transform 0.2s;
        }
        .comment:hover .delete-comment-btn { opacity: 1; transform: scale(1.1); }
        #comment-form { display: flex; align-items: center; gap: 0.5rem; margin-top: 0; flex-shrink: 0; }
        
        /* Playback Controls (Switch) */
        .playback-controls {
            margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-primary);
            flex-shrink: 0; /* Don't shrink this section */
        }
        .switch-container {
            display: flex; align-items: center; justify-content: space-between; cursor: pointer;
        }
        .switch-label {
            font-weight: 600; font-size: 0.9rem; color: var(--text-primary);
        }
        .switch {
            position: relative; display: inline-block; width: 44px; height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-tertiary); transition: .4s;
            border: 1px solid var(--border-secondary); border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px;
            background-color: var(--text-secondary); transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(20px); background-color: white; }


        /* Modal Tagging */
        .modal-tags-section { 
            margin-top: 1rem; border-top: 1px solid var(--border-primary); 
            padding-top: 1rem; margin-bottom: 1rem;
            flex-shrink: 0; /* Keep size stable */
        }
        #modal-tags-display, #available-tags-container { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        #available-tags-container { margin-top: 1rem; }
        .modal-tag {
            background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 0.25rem 0.6rem;
            border-radius: 999px; font-size: 0.8rem;
        }
        .available-tag-btn {
            background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 0.3rem 0.8rem;
            border: 1px solid var(--border-primary); border-radius: 999px; font-size: 0.8rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .available-tag-btn.active, .available-tag-btn:hover {
            background-color: var(--accent-primary); color: var(--text-on-accent); border-color: var(--accent-primary);
        }

        .modal-nav-btn {
            position: fixed; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.2);
            border: none; color: white; font-size: 2rem; cursor: pointer; width: 50px; height: 50px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .modal-nav-btn:hover { background: rgba(255, 255, 255, 0.4); }
        #prev-btn { left: 2%; }
        #next-btn { right: 2%; }
        #close-btn { top: 2%; right: 2%; width: 40px; height: 40px; font-size: 1.5rem; }

        /* Name Prompt Modal */
        .name-modal-box {
            background-color: var(--bg-secondary); padding: 2rem; border-radius: 1rem;
            width: 100%; max-width: 400px; text-align: center;
        }
        
        @media (max-width: 768px) {
            .modal-content { flex-direction: column; }
            .modal-details-container { border-left: none; border-top: 1px solid var(--border-primary); flex-grow: 1; min-height: 250px; }
            .nav-controls { gap: 0.5rem; }
            .navbar .logo { font-size: 1.25rem; }
        }
    </style>
</head>
<body>
    <div id="sidebar-overlay"></div>
    <div id="sidebar" class="sidebar">
        <div>
            <div class="sidebar-header">
                <h4 class="text-main">Color Palette</h4>
                <button id="close-sidebar-btn" title="Close menu">&times;</button>
            </div>
            <div id="theme-options" style="margin-top: 0.5rem;"></div>
        </div>
        <hr style="border-color: var(--border-primary); width: 100%;">
        <div>
            <h4 class="text-main" style="margin-bottom: 0.5rem;">User Profile</h4>
            <form id="user-profile-form">
                <label for="user-name-edit">Name</label>
                <input type="text" id="user-name-edit" class="input-main" required>
                <label for="user-avatar-url">Avatar URL</label>
                <input type="url" id="user-avatar-url" class="input-main" placeholder="https://...">
                <button type="submit" class="btn-primary" style="margin-top: 0.5rem;">Save Profile</button>
            </form>
        </div>
        <hr style="border-color: var(--border-primary); width: 100%;">
        <div>
            <h4 class="text-main" style="margin-bottom: 0.5rem;">Add Image by URL</h4>
            <div id="add-image-url-form">
                <label for="image-url-input" style="display: none;">Image URL</label>
                <input type="url" id="image-url-input" class="input-main" placeholder="https://...">
                <button id="add-url-btn" class="btn-primary">Add Image</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="logo">Softpix</div>
        <div class="nav-controls">
            <button id="global-mute-btn" class="btn-icon" title="Toggle Sound on Hover">
                <svg id="mute-icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
            </button>
            
            <button id="shuffle-grid-btn" class="btn-icon" title="Shuffle Grid View">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="16 3 21 3 21 8"></polyline>
                    <line x1="4" y1="20" x2="21" y2="3"></line>
                    <polyline points="21 16 21 21 16 21"></polyline>
                    <line x1="15" y1="15" x2="21" y2="21"></line>
                    <line x1="4" y1="4" x2="9" y2="9"></line>
                </svg>
            </button>

            <button id="surprise-btn" class="btn-surprise" title="Play a random video">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                   <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Surprise Me
            </button>

            <select id="column-count-select" class="sort-select" title="Items per row">
                <option value="auto">Auto</option>
                <option value="3">3 Columns</option>
                <option value="4">4 Columns</option>
                <option value="5">5 Columns</option>
                <option value="6">6 Columns</option>
                <option value="7">7 Columns</option>
            </select>

            <select id="sort-select" class="sort-select">
                <option value="pinned">Pinned First</option>
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="popular">Most Popular</option>
                <option value="rating-5">5 Stars Only</option>
                <option value="rating-4">4 Stars Only</option>
                <option value="rating-3">3 Stars Only</option>
                <option value="rating-2">2 Stars Only</option>
                <option value="rating-1">1 Star Only</option>
            </select>
            <button id="select-folder-btn" class="btn-primary">Select Folder</button>
            <button id="hamburger-menu" class="hamburger-menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6H20M4 12H20M4 18H20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
    
    <div id="tag-bar" class="tag-bar"></div>

    <main>
        <div id="image-grid"></div>
        
        <div id="empty-state">
            <svg class="w-16 h-16 text-subtle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 4rem; height: 4rem;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
            <h2 class="text-xl font-bold mt-4">No Folder Selected</h2>
            <p class="text-subtle">Click the button above to select a folder of images and videos to display.</p>
        </div>

        <div id="resume-state">
             <svg class="w-16 h-16 text-subtle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 4rem; height: 4rem;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            <h2 class="text-xl font-bold mt-4">Welcome Back</h2>
            <p class="text-subtle" style="margin-bottom: 1.5rem;">We found your previous folder: <strong id="resume-folder-name">...</strong></p>
            <button id="resume-btn" class="btn-primary">Resume Session</button>
            <p class="text-subtle" style="font-size: 0.8rem; margin-top: 1rem;">Browser security requires you to approve access again.</p>
        </div>
    </main>
    
    <div id="image-modal">
        <div class="modal-content">
            <div class="modal-image-container">
                <img id="modal-img" src="" alt="Expanded view" class="hidden-media">
                <video id="modal-video" controls class="hidden-media"></video>
            </div>
            <div class="modal-details-container">
                <h3 id="modal-title"></h3>
                
                <div class="modal-tags-section">
                    <p class="text-subtle" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem;">Tags on this item:</p>
                    <div id="modal-tags-display"></div>
                      <form id="tag-form" style="margin-top: 0.75rem;">
                        <input type="text" id="tag-input" class="input-main" placeholder="Add new tag & press Enter...">
                    </form>
                    <p class="text-subtle" style="font-weight: 600; font-size: 0.9rem; margin: 1rem 0 0.5rem 0;">Available Tags:</p>
                    <div id="available-tags-container"></div>
                </div>

                <div id="rating-section" class="rating-section">
                    <p class="text-subtle" style="font-weight: 600; font-size: 0.9rem; margin: 0;">Rating:</p>
                    <div id="stars-container" class="rating-stars">
                        </div>
                </div>

                <div id="comments-container"></div>
                
                <form id="comment-form">
                    <input type="text" id="comment-input" class="input-main" placeholder="Add a comment..." required>
                    <button type="submit" class="btn-secondary">Post</button>
                </form>

                <div class="playback-controls">
                    <label class="switch-container">
                        <span class="switch-label">Shuffle Next Video (Auto-Play)</span>
                        <div class="switch">
                            <input type="checkbox" id="shuffle-toggle">
                            <span class="slider round"></span>
                        </div>
                    </label>
                </div>

            </div>
        </div>
        <button id="close-btn" class="modal-nav-btn">&times;</button>
        <button id="prev-btn" class="modal-nav-btn">&#10094;</button>
        <button id="next-btn" class="modal-nav-btn">&#10095;</button>
    </div>

    <div id="name-modal">
        <div class="name-modal-box">
            <h2 class="text-2xl font-bold mb-2 text-main">Welcome to Softpix!</h2>
            <p class="text-subtle mb-4">Please enter your name to continue.</p>
            <form id="name-form">
                <input type="text" id="name-input" class="input-main mb-4" placeholder="Your Name..." required>
                <button type="submit" class="btn-primary">Save Name</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const imageGrid = document.getElementById('image-grid');
        const emptyState = document.getElementById('empty-state');
        const resumeState = document.getElementById('resume-state'); 
        const resumeBtn = document.getElementById('resume-btn'); 
        const resumeFolderName = document.getElementById('resume-folder-name'); 

        const imageModal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-img');
        const modalVideo = document.getElementById('modal-video');
        const modalTitle = document.getElementById('modal-title');
        const commentsContainer = document.getElementById('comments-container');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const closeBtn = document.getElementById('close-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const sortSelect = document.getElementById('sort-select');
        const columnCountSelect = document.getElementById('column-count-select');
        const shuffleGridBtn = document.getElementById('shuffle-grid-btn');
        const surpriseBtn = document.getElementById('surprise-btn'); 
        const tagForm = document.getElementById('tag-form');
        const tagInput = document.getElementById('tag-input');
        const modalTagsDisplay = document.getElementById('modal-tags-display');
        const availableTagsContainer = document.getElementById('available-tags-container');
        const tagBar = document.getElementById('tag-bar');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const themeOptions = document.getElementById('theme-options');
        const nameModal = document.getElementById('name-modal');
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name-input');
        const userProfileForm = document.getElementById('user-profile-form');
        const userNameEditInput = document.getElementById('user-name-edit');
        const userAvatarUrlInput = document.getElementById('user-avatar-url');
        const imageUrlInput = document.getElementById('image-url-input');
        const addUrlBtn = document.getElementById('add-url-btn');
        const selectFolderBtn = document.getElementById('select-folder-btn');
        const globalMuteBtn = document.getElementById('global-mute-btn');
        const muteIconSvg = document.getElementById('mute-icon-svg');
        const shuffleToggle = document.getElementById('shuffle-toggle');
        const starsContainer = document.getElementById('stars-container'); // NEW ELEMENT

        // --- State ---
        let localImageFiles = []; 
        let displayedItems = [];
        let currentImageIndex = -1;
        let activeFilterTags = [];
        let isGlobalMute = true;
        let pendingFolderHandle = null; 
        
        // Auto shuffle state
        let isAutoShuffleOn = false; 

        // --- Mute Logic ---
        function updateMuteIcon() {
            if (isGlobalMute) {
                // Muted Icon
                muteIconSvg.innerHTML = `
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                `;
                globalMuteBtn.title = "Current: Muted (Click to Unmute)";
            } else {
                // Unmuted (Sound On) Icon
                muteIconSvg.innerHTML = `
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                `;
                globalMuteBtn.title = "Current: Sound On (Click to Mute)";
            }
        }

        globalMuteBtn.addEventListener('click', () => {
            isGlobalMute = !isGlobalMute;
            updateMuteIcon();
        });

        updateMuteIcon();


        // --- THEME LOGIC ---
        const accentColors = [
            { name: 'green', color: '#16a34a' }, { name: 'blue', color: '#2563eb' },
            { name: 'red', color: '#dc2626' }, { name: 'purple', color: '#9333ea' }
        ];
        const applyAccentColor = (accentName) => {
            document.documentElement.setAttribute('data-accent', accentName);
            localStorage.setItem('softpixAccentColor', accentName);
            updateActiveThemeButtons();
        };
        const updateActiveThemeButtons = () => {
            const currentAccent = document.documentElement.dataset.accent;
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.accent === currentAccent));
        };
        const populateThemeSidebar = () => {
            const accentSwatches = document.createElement('div');
            accentSwatches.classList.add('flex', 'items-center', 'justify-start', 'gap-4');
            accentColors.forEach(accent => {
                const swatch = document.createElement('button');
                swatch.dataset.accent = accent.name;
                swatch.classList.add('theme-btn');
                swatch.style.backgroundColor = accent.color;
                swatch.addEventListener('click', () => applyAccentColor(accent.name));
                accentSwatches.appendChild(swatch);
            });
            themeOptions.appendChild(accentSwatches);
            updateActiveThemeButtons();
        };

        // --- Persistence with IndexedDB for Folder Handle ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('galleryDB', 1);
                request.onupgradeneeded = e => e.target.result.createObjectStore('folder', { keyPath: 'id' });
                request.onsuccess = e => resolve(e.target.result);
                request.onerror = e => reject(e.target.error);
            });
        }
        async function saveFolderHandle(handle) {
            try {
                const db = await openDB();
                const tx = db.transaction('folder', 'readwrite');
                tx.objectStore('folder').put({ id: 'mainFolder', handle });
                return tx.complete;
            } catch(e) { console.error("Could not save folder handle.", e); }
        }
        async function getSavedFolderHandle() {
            try {
                const db = await openDB();
                return new Promise((resolve) => {
                    const tx = db.transaction('folder', 'readonly');
                    const req = tx.objectStore('folder').get('mainFolder');
                    req.onsuccess = () => resolve(req.result ? req.result.handle : null);
                    req.onerror = () => resolve(null);
                });
            } catch(e) {
                console.error("Could not retrieve folder handle.", e);
                return null;
            }
        }

        // --- File System & Image/Video Loading (Recursive) ---
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
        const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.m4v'];
        const allExtensions = [...imageExtensions, ...videoExtensions];

        async function getFolder() {
            try {
                const folderHandle = await window.showDirectoryPicker({
                    id: 'softpix_working_dir',
                    startIn: 'downloads'
                });
                await saveFolderHandle(folderHandle);
                await loadLocalImages(folderHandle);
                await renderGrid();
            } catch (err) { console.error('Error selecting folder:', err); }
        }

        async function traverseDirectory(dirHandle) {
            let files = [];
            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') {
                        if (allExtensions.some(ext => entry.name.toLowerCase().endsWith(ext))) {
                            const file = await entry.getFile();
                            files.push({
                                handle: entry, 
                                name: entry.name, 
                                lastModified: file.lastModified,
                                isVideo: videoExtensions.some(ext => entry.name.toLowerCase().endsWith(ext))
                            });
                        }
                    } else if (entry.kind === 'directory') {
                        const subFiles = await traverseDirectory(entry);
                        files = files.concat(subFiles);
                    }
                }
            } catch (e) {
                console.warn("Could not read subdirectory", e);
            }
            return files;
        }

        async function loadLocalImages(handle) {
            if (!handle) { 
                localImageFiles = [];
                return;
            };
            try {
                localImageFiles = await traverseDirectory(handle);
            } catch (e) {
                console.error("Error reading files. Permission may have been revoked.", e);
                alert("Could not read files. Please re-select the folder.");
                localImageFiles = [];
            }
        }
        
        // --- External URL Logic ---
        function addImageByUrl(url) {
            if (!url) return;
            let savedUrls = getFromStorage('externalImageUrls') || [];
            if (!savedUrls.includes(url)) {
                savedUrls.push(url);
                saveToStorage('externalImageUrls', savedUrls);
                renderGrid();
            }
        }

        // --- Grid Shuffle Logic ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function shuffleGridItems() {
            // Shuffle the currently displayed items and re-render grid
            displayedItems = shuffleArray([...displayedItems]);
            renderDOM(displayedItems);
        }

        // --- Unified Grid Rendering ---
        async function renderGrid() {
            let items = [];
            localImageFiles.forEach(fileData => items.push({ type: 'local', ...fileData }));
            const savedUrls = getFromStorage('externalImageUrls') || [];
            
            savedUrls.forEach(url => {
                const name = url.split('/').pop().split('?')[0];
                const isVid = videoExtensions.some(ext => name.toLowerCase().endsWith(ext));
                items.push({ type: 'external', name: name, url: url, lastModified: 0, isVideo: isVid });
            });

            const sortBy = sortSelect.value;
            const popularity = getFromStorage('imagePopularity') || {};
            const pinnedImages = getFromStorage('pinnedImages') || [];
            
            // FILTERING LOGIC FOR STARS (NEW)
            if (sortBy.startsWith('rating-')) {
                const targetRating = parseInt(sortBy.split('-')[1]);
                const ratings = getFromStorage('imageRatings') || {};
                // Filter items to keep ONLY those with the specific star rating
                items = items.filter(item => {
                    const itemRating = ratings[item.name] || 0;
                    return itemRating === targetRating;
                });
            } else {
                // Normal Sort Logic
                items.sort((a, b) => {
                    if (sortBy === 'pinned') {
                        const aIsPinned = pinnedImages.includes(a.name);
                        const bIsPinned = pinnedImages.includes(b.name);
                        if (aIsPinned !== bIsPinned) return bIsPinned - aIsPinned;
                    }
                    if (sortBy === 'newest' || sortBy === 'pinned') return b.lastModified - a.lastModified;
                    if (sortBy === 'oldest') return a.lastModified - b.lastModified;
                    if (sortBy === 'popular') return (popularity[b.name] || 0) - (popularity[a.name] || 0);
                    return 0;
                });
            }
            
            if (activeFilterTags.length > 0) {
                const allTags = getFromStorage('imageTags') || {};
                items = items.filter(item => {
                    const itemTags = allTags[item.name] || [];
                    return activeFilterTags.some(filterTag => itemTags.includes(filterTag));
                });
            }

            displayedItems = items;
            renderDOM(displayedItems);
        }

        function renderDOM(itemsToRender) {
            imageGrid.innerHTML = '';
            
            if (itemsToRender.length === 0) {
                // If we have items but they are filtered out, show empty state.
                // If we literally have no items loaded, show the relevant empty/resume state
                if (localImageFiles.length === 0 && getFromStorage('externalImageUrls')?.length === 0) {
                     // handled by init/permission logic
                     imageGrid.style.display = 'none';
                } else {
                     emptyState.style.display = 'flex';
                     imageGrid.style.display = 'none';
                }
                return;
            }
            
            emptyState.style.display = 'none';
            resumeState.style.display = 'none'; 
            imageGrid.style.display = 'grid';

            const pinnedImages = getFromStorage('pinnedImages') || [];

            itemsToRender.forEach(async (item, index) => {
                let mediaUrl;
                if (item.type === 'local') {
                    const file = await item.handle.getFile();
                    mediaUrl = URL.createObjectURL(file);
                } else { mediaUrl = item.url; }

                const pinContainer = document.createElement('div');
                pinContainer.classList.add('pin-container');
                
                let mediaElement;
                if (item.isVideo) {
                    mediaElement = document.createElement('video');
                    mediaElement.loop = true;
                    mediaElement.setAttribute('playsinline', '');
                    mediaElement.src = mediaUrl;
                    
                    // Hover Play with Global Mute Logic
                    pinContainer.addEventListener('mouseenter', () => {
                        mediaElement.muted = isGlobalMute;
                        const playPromise = mediaElement.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.log('Auto-play prevented:', error);
                                if(!isGlobalMute) { mediaElement.muted = true; mediaElement.play(); }
                            });
                        }
                    });

                    pinContainer.addEventListener('mouseleave', () => {
                        mediaElement.pause();
                        mediaElement.currentTime = 0;
                    });

                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.src = mediaUrl;
                }
                
                mediaElement.onerror = () => { pinContainer.remove(); };
                
                const pinBtn = document.createElement('button');
                pinBtn.classList.add('pin-btn');
                pinBtn.title = "Pin item";
                pinBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.05 3.55L12 6.6L8.95 3.55C7.99 2.59 6.51 2.59 5.55 3.55C4.59 4.51 4.59 5.99 5.55 6.95L8.38 9.78C7.6 10.56 7.12 11.22 7 12H12V21L13 22L14 21V12H17C16.88 11.22 16.4 10.56 15.62 9.78L18.45 6.95C19.41 5.99 19.41 4.51 18.45 3.55C17.49 2.59 16.01 2.59 15.05 3.55Z"></path></svg>`;
                if (pinnedImages.includes(item.name)) pinBtn.classList.add('active');
                pinBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePin(item.name, pinBtn);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.title = "Remove from gallery";
                deleteBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteImage(item);
                });
                
                pinContainer.appendChild(mediaElement);
                if (item.isVideo) {
                    const vidIndicator = document.createElement('div');
                    vidIndicator.classList.add('video-indicator');
                    vidIndicator.innerText = "VIDEO";
                    pinContainer.appendChild(vidIndicator);
                }

                pinContainer.appendChild(pinBtn);
                pinContainer.appendChild(deleteBtn);
                imageGrid.appendChild(pinContainer);
                pinContainer.addEventListener('click', () => openModal(index));
            });
        }
        
        // --- Modal & Sidebar Logic ---
        async function openModal(index) {
            if (index < 0 || index >= displayedItems.length) return;
            currentImageIndex = index;
            const item = displayedItems[index];
            trackPopularity(item.name);
            
            let mediaUrl;
            if(item.type === 'local') {
                const file = await item.handle.getFile();
                mediaUrl = URL.createObjectURL(file);
            } else { mediaUrl = item.url; }

            // Toggle Image vs Video element in modal
            if (item.isVideo) {
                modalImg.classList.add('hidden-media');
                modalVideo.classList.remove('hidden-media');
                modalVideo.src = mediaUrl;
                modalVideo.muted = false; 
                modalVideo.play().catch(()=>{}); 
            } else {
                modalVideo.classList.add('hidden-media');
                modalImg.classList.remove('hidden-media');
                modalVideo.pause(); // Stop any previous video
                modalImg.src = mediaUrl;
            }

            modalTitle.textContent = item.name;
            imageModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            loadComments(item.name);
            loadTagsForModal(item.name);
            loadAvailableTags(item.name);
            setupRatingUI(item.name); // NEW: Load rating
        }
        function closeModal() {
            imageModal.style.display = 'none';
            // Cleanup URLs
            if (modalImg.src.startsWith('blob:')) URL.revokeObjectURL(modalImg.src);
            if (modalVideo.src.startsWith('blob:')) URL.revokeObjectURL(modalVideo.src);
            
            modalImg.src = '';
            modalVideo.src = '';
            modalVideo.pause(); // Stop video
            document.body.style.overflow = 'auto';
        }
        function closeSidebar() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('visible');
        }
        
        function showNextImage() { openModal((currentImageIndex + 1) % displayedItems.length); }
        function showPrevImage() { openModal((currentImageIndex - 1 + displayedItems.length) % displayedItems.length); }


        // --- NEW: Toggle Listener & Video End Logic ---
        shuffleToggle.addEventListener('change', (e) => {
            isAutoShuffleOn = e.target.checked;
        });

        // Event: When modal video finishes playing
        modalVideo.addEventListener('ended', () => {
            if (displayedItems.length <= 1) return; 

            // 1. Check if CURRENT video is PINNED
            const currentItem = displayedItems[currentImageIndex];
            const pinnedImages = getFromStorage('pinnedImages') || [];
            const isCurrentPinned = pinnedImages.includes(currentItem.name);

            // 2. Logic decision
            if (isCurrentPinned) {
                showNextImage(); 
            } else {
                if (isAutoShuffleOn) {
                    let nextRandomIndex;
                    do {
                        nextRandomIndex = Math.floor(Math.random() * displayedItems.length);
                    } while (nextRandomIndex === currentImageIndex);
                    openModal(nextRandomIndex);
                } else {
                    showNextImage();
                }
            }
        });


        // --- Local Storage & User Logic ---
        function getFromStorage(key) {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        }
        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        function trackPopularity(imageName) {
            const popularity = getFromStorage('imagePopularity') || {};
            popularity[imageName] = (popularity[imageName] || 0) + 1;
            saveToStorage('imagePopularity', popularity);
        }

        // --- NEW: RATING LOGIC ---
        function setupRatingUI(imageName) {
            starsContainer.innerHTML = '';
            const allRatings = getFromStorage('imageRatings') || {};
            const currentRating = allRatings[imageName] || 0;

            // Create 5 stars
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('div');
                star.innerHTML = `<svg class="star-icon ${i <= currentRating ? 'filled' : ''}" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                
                // Click to set rating
                star.addEventListener('click', () => {
                    const ratings = getFromStorage('imageRatings') || {};
                    ratings[imageName] = i;
                    saveToStorage('imageRatings', ratings);
                    updateStarsVisual(i);
                    // If filtering by rating, grid might need update next time, but simple here.
                });

                // Hover effects
                star.addEventListener('mouseover', () => updateStarsVisual(i));
                
                starsContainer.appendChild(star);
            }

            // Mouse leave container: reset to saved rating
            starsContainer.addEventListener('mouseleave', () => {
                const savedRatings = getFromStorage('imageRatings') || {};
                updateStarsVisual(savedRatings[imageName] || 0);
            });
        }

        function updateStarsVisual(rating) {
            const svgs = starsContainer.querySelectorAll('.star-icon');
            svgs.forEach((svg, index) => {
                if (index < rating) svg.classList.add('filled');
                else svg.classList.remove('filled');
            });
        }

        // --- Image, Comments, Tags, and Pins Logic ---
        function deleteImage(itemToDelete) {
            if (itemToDelete.type === 'local') {
                localImageFiles = localImageFiles.filter(file => file.name !== itemToDelete.name);
            } else if (itemToDelete.type === 'external') {
                let savedUrls = getFromStorage('externalImageUrls') || [];
                savedUrls = savedUrls.filter(url => url !== itemToDelete.url);
                saveToStorage('externalImageUrls', savedUrls);
            }
            
            const keysToDelete = ['imageComments', 'imageTags', 'imagePopularity', 'pinnedImages', 'imageRatings'];
            keysToDelete.forEach(key => {
                let data = getFromStorage(key);
                if (data) {
                    if (Array.isArray(data)) {
                        data = data.filter(name => name !== itemToDelete.name);
                    } else if (typeof data === 'object') {
                        delete data[itemToDelete.name];
                    }
                    saveToStorage(key, data);
                }
            });

            renderGrid();
            updateTagBar();
        }

        function togglePin(imageName, btn) {
            let pinned = getFromStorage('pinnedImages') || [];
            if (pinned.includes(imageName)) {
                pinned = pinned.filter(name => name !== imageName);
                btn.classList.remove('active');
            } else {
                pinned.push(imageName);
                btn.classList.add('active');
            }
            saveToStorage('pinnedImages', pinned);
            if (sortSelect.value === 'pinned') renderGrid();
        }

        function loadComments(imageName) {
            commentsContainer.innerHTML = '';
            const allComments = getFromStorage('imageComments') || {};
            const imageComments = allComments[imageName] || [];
            const avatarUrl = getFromStorage('softpixUserAvatar');
            const currentUser = getFromStorage('softpixUserName');

            if (imageComments.length === 0) {
                 commentsContainer.innerHTML = `<p class="text-subtle">No comments yet.</p>`;
                 return;
            }
            imageComments.forEach(comment => {
                const commentEl = document.createElement('div');
                commentEl.classList.add('comment');
                const authorInitial = comment.author ? comment.author.charAt(0).toUpperCase() : '?';
                const avatar = (avatarUrl && comment.author === currentUser)
                    ? `<img src="${avatarUrl}" class="comment-avatar" alt="Avatar">`
                    : `<div class="comment-avatar">${authorInitial}</div>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.classList.add('delete-comment-btn');
                deleteBtn.title = "Delete comment";
                deleteBtn.addEventListener('click', () => deleteComment(imageName, comment.date));
                commentEl.innerHTML = `<div class="comment-header">${avatar}<span class="comment-author">${comment.author || 'Anonymous'}</span></div><p>${comment.text}</p><div class="comment-date">${new Date(comment.date).toLocaleString()}</div>`;
                if (comment.author === currentUser) commentEl.appendChild(deleteBtn);
                commentsContainer.appendChild(commentEl);
            });
        }
        function addComment(e) {
            e.preventDefault();
            const text = commentInput.value.trim();
            if (!text) return;
            const imageName = modalTitle.textContent;
            const allComments = getFromStorage('imageComments') || {};
            if (!allComments[imageName]) allComments[imageName] = [];
            allComments[imageName].push({ text, author: getFromStorage('softpixUserName'), date: new Date().toISOString() });
            saveToStorage('imageComments', allComments);
            loadComments(imageName);
            commentForm.reset();
        }
        function deleteComment(imageName, timestamp) {
            const allComments = getFromStorage('imageComments') || {};
            if (!allComments[imageName]) return;
            allComments[imageName] = allComments[imageName].filter(c => c.date !== timestamp);
            saveToStorage('imageComments', allComments);
            loadComments(imageName);
        }
        
        function loadTagsForModal(imageName) {
            modalTagsDisplay.innerHTML = '';
            const allTags = getFromStorage('imageTags') || {};
            const imageTags = allTags[imageName] || [];
            if(imageTags.length === 0) modalTagsDisplay.innerHTML = `<p class="text-subtle" style="font-size:0.8rem">No tags yet.</p>`;
            else imageTags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.classList.add('modal-tag');
                tagEl.textContent = tag;
                modalTagsDisplay.appendChild(tagEl);
            });
        }
        
        function addTag(e) {
            e.preventDefault();
            const tagText = tagInput.value.trim().toLowerCase();
            if (!tagText) return;
            const imageName = modalTitle.textContent;
            toggleTag(tagText, imageName);
            tagForm.reset();
        }

        function loadAvailableTags(imageName) {
            availableTagsContainer.innerHTML = '';
            const allTags = getFromStorage('imageTags') || {};
            const uniqueTags = new Set(Object.values(allTags).flat());
            const currentImageTags = allTags[imageName] || [];

            if (uniqueTags.size === 0) {
                availableTagsContainer.innerHTML = `<p class="text-subtle" style="font-size:0.8rem">Create a tag to get started.</p>`;
                return;
            }

            uniqueTags.forEach(tag => {
                const tagBtn = document.createElement('button');
                tagBtn.classList.add('available-tag-btn');
                tagBtn.textContent = tag;
                if (currentImageTags.includes(tag)) tagBtn.classList.add('active');
                tagBtn.addEventListener('click', () => toggleTag(tag, imageName));
                availableTagsContainer.appendChild(tagBtn);
            });
        }

        function toggleTag(tagName, imageName) {
            const allTags = getFromStorage('imageTags') || {};
            if (!allTags[imageName]) allTags[imageName] = [];
            
            if (allTags[imageName].includes(tagName)) {
                allTags[imageName] = allTags[imageName].filter(t => t !== tagName);
            } else {
                allTags[imageName].push(tagName);
            }

            saveToStorage('imageTags', allTags);
            loadTagsForModal(imageName);
            loadAvailableTags(imageName);
            updateTagBar();
        }

        function updateTagBar() {
            tagBar.innerHTML = '';
            const allTags = getFromStorage('imageTags') || {};
            const uniqueTags = new Set(Object.values(allTags).flat());
            
            if (uniqueTags.size > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.textContent = 'Clear Filter';
                clearBtn.classList.add('clear-filter-btn');
                clearBtn.addEventListener('click', () => {
                    activeFilterTags = [];
                    renderGrid();
                    updateTagBar();
                });
                tagBar.appendChild(clearBtn);

                uniqueTags.forEach(tag => {
                    const container = document.createElement('div');
                    container.classList.add('tag-btn-container');
                    const tagBtn = document.createElement('button');
                    tagBtn.textContent = tag;
                    tagBtn.dataset.tag = tag;
                    tagBtn.classList.add('tag-btn');
                    if (activeFilterTags.includes(tag)) tagBtn.classList.add('active');
                    tagBtn.addEventListener('click', () => filterByTag(tag, tagBtn));
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.classList.add('delete-tag-btn');
                    deleteBtn.title = "Delete tag from all images";
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteTag(tag);
                    });
                    container.appendChild(tagBtn);
                    container.appendChild(deleteBtn);
                    tagBar.appendChild(container);
                });
            }
        }
        
        function filterByTag(tag, clickedButton) {
            const tagIndex = activeFilterTags.indexOf(tag);
            if (tagIndex > -1) {
                activeFilterTags.splice(tagIndex, 1);
            } else {
                activeFilterTags.push(tag);
            }
            renderGrid();
            updateTagBar();
        }

        function deleteTag(tagToDelete) {
            const allTags = getFromStorage('imageTags') || {};
            for (const imageName in allTags) {
                allTags[imageName] = allTags[imageName].filter(t => t !== tagToDelete);
            }
            saveToStorage('imageTags', allTags);
            activeFilterTags = activeFilterTags.filter(t => t !== tagToDelete);
            renderGrid();
            updateTagBar();
        }

        // --- Column Count Logic ---
        function updateGridColumns() {
            const cols = columnCountSelect.value;
            saveToStorage('softpixGridColumns', cols);
            if (cols === 'auto') {
                imageGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
            } else {
                imageGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            }
        }
        columnCountSelect.addEventListener('change', updateGridColumns);

        // --- NEW: Resume Permission Handler ---
        resumeBtn.addEventListener('click', async () => {
             if (pendingFolderHandle) {
                 const permission = await pendingFolderHandle.requestPermission({ mode: 'read' });
                 if (permission === 'granted') {
                     await loadLocalImages(pendingFolderHandle);
                     await renderGrid();
                 } else {
                     alert("Permission denied. Please select the folder again.");
                 }
             }
        });

        // --- NEW: Surprise Me Logic ---
        surpriseBtn.addEventListener('click', () => {
            // Filter displayedItems to find videos only
            const videoIndices = displayedItems
                .map((item, index) => item.isVideo ? index : -1)
                .filter(index => index !== -1);

            if (videoIndices.length === 0) {
                alert("No videos found to surprise you with! Please add some videos or clear filters.");
                return;
            }

            // Totally random each time
            const randomIndex = Math.floor(Math.random() * videoIndices.length);
            const targetIndex = videoIndices[randomIndex];
            
            // Open the modal
            openModal(targetIndex);
        });

        // --- Event Listeners ---
        selectFolderBtn.addEventListener('click', getFolder);
        addUrlBtn.addEventListener('click', () => {
            const url = imageUrlInput.value.trim();
            addImageByUrl(url);
            imageUrlInput.value = '';
        });
        sortSelect.addEventListener('change', renderGrid);
        shuffleGridBtn.addEventListener('click', shuffleGridItems);
        closeBtn.addEventListener('click', closeModal);
        nextBtn.addEventListener('click', showNextImage);
        prevBtn.addEventListener('click', showPrevImage);
        commentForm.addEventListener('submit', addComment);
        tagForm.addEventListener('submit', addTag);
        hamburgerMenu.addEventListener('click', () => {
            userNameEditInput.value = getFromStorage('softpixUserName') || '';
            userAvatarUrlInput.value = getFromStorage('softpixUserAvatar') || '';
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('visible');
        });
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) closeModal();
        });
        nameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            if(name){
                saveToStorage('softpixUserName', name);
                nameModal.style.display = 'none';
            }
        });
        userProfileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = userNameEditInput.value.trim();
            const newAvatar = userAvatarUrlInput.value.trim();
            if(newName) saveToStorage('softpixUserName', newName);
            saveToStorage('softpixUserAvatar', newAvatar);
            alert('Profile saved!');
            closeSidebar();
        });
        window.addEventListener('keydown', (e) => {
            if (imageModal.style.display === 'flex') {
                if (e.key === 'Escape') closeModal();
                if (document.activeElement.id !== 'comment-input' && document.activeElement.id !== 'tag-input') {
                    if (e.key === 'ArrowRight') showNextImage();
                    if (e.key === 'ArrowLeft') showPrevImage();
                }
            }
        });
        
        // --- Initialization ---
        async function init() {
            if (!getFromStorage('softpixUserName')) {
                nameModal.style.display = 'flex';
                nameInput.focus();
            }

            const savedAccent = localStorage.getItem('softpixAccentColor') || 'green';
            applyAccentColor(savedAccent);
            populateThemeSidebar();
            
            const savedCols = getFromStorage('softpixGridColumns') || 'auto';
            columnCountSelect.value = savedCols;
            updateGridColumns();

            // Load Saved URLs first (they don't need permissions)
            const savedUrls = getFromStorage('externalImageUrls') || [];
            if(savedUrls.length > 0) await renderGrid();

            // Check IndexedDB for Folder Handle
            const folderHandle = await getSavedFolderHandle();
            if (folderHandle) {
                // Check permissions
                const permission = await folderHandle.queryPermission({ mode: 'read' });
                
                if (permission === 'granted') {
                    // Browser still has permission (rare after restart, common on refresh)
                    await loadLocalImages(folderHandle);
                    await renderGrid();
                } else if (permission === 'prompt') {
                    // Handle exists, but user must re-approve.
                    // We cannot call requestPermission() here automatically (browser blocks it).
                    // We must show a button.
                    pendingFolderHandle = folderHandle;
                    emptyState.style.display = 'none';
                    imageGrid.style.display = 'none';
                    resumeState.style.display = 'flex';
                    resumeFolderName.textContent = folderHandle.name;
                }
            }
            updateTagBar();
        }
        
        init();
    });
    </script>
</body>
</html>
